<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>

  <body>
    <section id="input">
      <div id="form">
      </div>
      <button onclick="generateImage()">Generate image</button>
    </section>

    <div id="canvas">
      <div class="headline">
        <div id="country"></div>
        <div id="event">
          <h1 id="h1"></h1>
          <h2 id="h2"></h2>
        </div>
      </div>

      <div id="ranking">
        <div class="driver" id="driver1"></div>
        <div class="driver" id="driver2"></div>
        <div class="driver" id="driver3"></div>
        <div class="driver" id="driver4"></div>
        <div class="driver" id="driver5"></div>
        <div class="driver" id="driver6"></div>
        <div class="driver" id="driver7"></div>
        <div class="driver" id="driver8"></div>
        <div class="driver" id="driver9"></div>
        <div class="driver" id="driver10"></div>
        <div class="driver" id="driver11"></div>
      </div>

      <img id="logo" src="img/logo.png" />
    </div>

    <section id="download">
      <button id="btn-download" onclick="downloadImage(canvas, 'fahrerwertung.png')">Download image</button>
    </section>

    <script type="text/javascript" src="js/html2canvas.min.js"></script>
    <script type="text/javascript" src="js/canvas2image.js"></script>
    <script type="text/javascript" src="js/mapping.js"></script>
    <script type="text/javascript">
      var drivers = [];

      window.onload = function() {
        generateForm();
      };

      function generateForm() {
        document.getElementById('form').insertAdjacentHTML(
          'beforeend',
          '<div><label for="headline">Headline</label><input type="text" id="headline" name="headline" value="Fahrerwertung" /></div>' +
          '<div><label for="subline">E-Prix</label><input type="text" id="subline" name="subline" value=" E-Prix" /></div>' +
          '<div class="tablehead"><span>Position</span><span>Name</span><span>Points</span></div>'
        );

        for (var i = 1; i < 12; i++) {
          document.getElementById('form').insertAdjacentHTML('beforeend', '<div class="driver' + i + 'Input"><div><input type="number" id="driver' + i + 'pos" name="driver' + i + 'pos" value=' + i + ' /></div><div><input type="text" id="driver' + i + 'name" name="driver' + i + 'name" /></div><div><input type="number" id="driver' + i + 'pts" name="driver' + i + 'pts" /></div></div>');
        }
      }

      function createObject() {
        drivers.length = 0;

        for (var i = 1; i < 12; i++) {
          drivers.push({
            "position": parseInt(i),
            "name": document.getElementById('driver' + i + 'name').value,
            "points": parseInt(document.getElementById('driver' + i + 'pts').value),
            "nationality": getNationality(document.getElementById('driver' + i + 'name').value),
            "team": getTeam(document.getElementById('driver' + i + 'name').value)
          });
        }
      }

      function generateImage() {
        document.getElementById('canvas').style.display = "block";
        createObject();

        var h1 = document.getElementById('headline').value;
        var h2 = document.getElementById('subline').value;
        var eventImg = '<img class="flag" src="img/flags/' + getCountry(h2) + '.png">';

        document.getElementById('h1').innerHTML = document.getElementById('headline').value;
        document.getElementById('h2').innerHTML = document.getElementById('subline').value;
        document.getElementById('country').innerHTML = eventImg;

        for (var i = 1; i < 12; i++) {
          document.getElementById('driver' + i).innerHTML =
          '<div class="position">' + drivers[(i-1)].position + '</div>' +
          '<div class="person">' +
            '<img class="flag" src="img/flags/' + drivers[(i-1)].nationality + '.png">' +
            '<div class="name">' + drivers[(i-1)].name + '</div>' +
            '<img class="team" src="img/cars/' + drivers[(i-1)].team + '.png">' +
          '</div>' +
          '<div class="points">' + drivers[(i-1)].points + '</div>';
        }

        document.getElementById('canvas').scrollIntoView();

        downloadImage();
      }

      function downloadImage() {

        html2canvas(document.querySelector("#canvas"), {
          allowTaint: true
        }).then(canvas => {
          // document.body.insertAdjacentHTML('beforeend', '<p id="hint">Right Click => Save</p>');
          // document.getElementById('canvas').style.display = "none";
          // document.body.appendChild(canvas);
          // download(canvas, 'fahrerwertung.png');
          // document.getElementById('hint').scrollIntoView();
        });
      }

      /* Canvas Donwload */
      function download(canvas, filename) {
        /// create an "off-screen" anchor tag
        var lnk = document.createElement('a'), e;

        /// the key here is to set the download attribute of the a tag
        lnk.download = filename;

        /// convert canvas content to data-uri for link. When download
        /// attribute is set the content pointed to by link will be
        /// pushed as "download" in HTML5 capable browsers
        lnk.href = canvas.toDataURL("image/png;base64");

        /// create a "fake" click-event to trigger the download
        if (document.createEvent) {
          e = document.createEvent("MouseEvents");
          e.initMouseEvent("click", true, true, window,
                           0, 0, 0, 0, 0, false, false, false,
                           false, 0, null);

          lnk.dispatchEvent(e);
        } else if (lnk.fireEvent) {
          lnk.fireEvent("onclick");
        }
      }
    </script>

  </body>
</html>
