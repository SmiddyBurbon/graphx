<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="css/style.css" />
  </head>

  <body>
    <section id="input">
      <div id="form">
      </div>
      <button onclick="generateImage()">Generate image</button>
    </section>

    <div id="canvas" class="drivers">
      <div class="headline">
        <div id="country"></div>
        <div id="event">
          <h1 id="h1"></h1>
          <h2 id="h2"></h2>
        </div>
        <div id="sponsor">
          <img src="img/we_logo.svg" alt="Presented by WÃ¼rth Elektronik" />
        </div>
      </div>

      <div id="ranking">
        <div class="driver" id="driver1"></div>
        <div class="driver" id="driver2"></div>
        <div class="driver" id="driver3"></div>
        <div class="driver" id="driver4"></div>
        <div class="driver" id="driver5"></div>
        <div class="driver" id="driver6"></div>
        <div class="driver" id="driver7"></div>
        <div class="driver" id="driver8"></div>
        <div class="driver" id="driver9"></div>
        <div class="driver" id="driver10"></div>
        <div class="driver" id="driver11"></div>
        <div class="driver" id="driver12"></div>
      </div>

      <img id="logo" class="small" src="img/logo_small.png" />
    </div>

    <section id="download">
      <button id="btn-download" onclick="downloadImage('fahrerwertung')">Download image</button>
    </section>

    <script type="text/javascript" src="js/html2canvas.min.js"></script>
    <script type="text/javascript" src="js/canvas2image.js"></script>
    <script type="text/javascript" src="js/mapping.js"></script>
    <!-- <script type="text/javascript" src="json/drivers_s6.js"></script> -->
    <script type="text/javascript" src="js/download.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

    <script>

    </script>

    <script type="text/javascript">
      window.onload = function() {
        getStandings();
      };

      var drivers = [];

      function SortByPosition(x,y) {
        return x.position - y.position;
      }

      async function getStandings() {
        let req = await new XMLHttpRequest();

        req.onreadystatechange = () => {
          if (req.readyState == XMLHttpRequest.DONE) {

            drivers = JSON.parse(req.responseText);
            drivers.sort(SortByPosition);
            generateForm();
          }
        };

        req.open("GET", "https://api.jsonbin.io/b/5d487a1589ed890b24cc439a/latest", true);
        req.setRequestHeader("secret-key", "$2a$10$zb.7WciGrkZ0z3cUhocfwOQNqUN8f1CDPzVi5WlvczORTF5OBiyt6");
        req.send();
      }

      async function updateStandings() {
        let req = await new XMLHttpRequest();
        let json;

        req.onreadystatechange = () => {
          if (req.readyState == XMLHttpRequest.DONE) {
          }
        };

        req.open("PUT", "https://api.jsonbin.io/b/5d487a1589ed890b24cc439a", true);
        req.setRequestHeader("secret-key", "$2a$10$zb.7WciGrkZ0z3cUhocfwOQNqUN8f1CDPzVi5WlvczORTF5OBiyt6");
        req.setRequestHeader("Content-type", "application/json");
        req.setRequestHeader("versioning", "true");
        req.send(JSON.stringify(drivers));
        getStandings();
      }

      function updatePositions(evt) {
        var found = drivers.find(function(driver) {
          return driver.position == evt.oldIndex + 1
        });

        if(evt.newIndex < evt.oldIndex) {
          drivers.forEach(function(driver) {
            if(driver.position == found.position) {
              driver.position = evt.newIndex + 1;
            }
            else if(driver.position < found.position) {
              driver.position++;
            }
          })
        }
        else if(evt.newIndex > evt.oldIndex) {
          drivers.forEach(function(driver) {
            if(driver.position > evt.oldIndex && driver.position < evt.newIndex + 2) {
              driver.position--;
            }
            if(driver.position == found.position) {
              driver.position = evt.newIndex + 1;
            }
          })
        }

        drivers.sort(SortByPosition);
        console.log(drivers);
        updateStandings();
      }

      function generateForm() {
        document.getElementById('form').insertAdjacentHTML(
          'beforeend',
          '<div><label for="headline">Headline</label><input type="text" id="headline" name="headline" value="Fahrerwertung" /></div>' +
          '<div><label for="subline">E-Prix</label><input type="text" id="subline" name="subline" value=" E-Prix" /></div>');

        // Create an unordered list
        var list = document.createElement('ul');
        list.setAttribute("id", "sortable");

        // Create a fragement
        var fragment = document.createDocumentFragment();

        // Create a list item for each wizard
        // and append it to the list
        drivers.forEach(function (driver) {
        	var li = document.createElement('li');

          var flag = document.createElement('img');
          flag.className = "flag";
          flag.src = 'img/flags/' + driver.nationality + '.png';

          var name = document.createElement('span');
          name.textContent = driver.name;

          var position = document.createElement('span');
          position.textContent = driver.position;

          var points = document.createElement('input');
          points.type = "text";
          points.placeholder = driver.points;

          li.appendChild(position);
          li.appendChild(flag);
          li.appendChild(name);
          li.appendChild(points);

        	fragment.appendChild(li);
        });

        // Append the fragement to the list
        list.appendChild(fragment);

        document.getElementById('form').appendChild(list);

        var el = document.getElementById('sortable');
        var sortable = new Sortable(el, {
          onEnd: function(evt) {
            updatePositions(evt);
          },
          dragClass: "dragged",  // Class name for the dragging item
          ghostClass: "ghost",  // Class name for the dragging item
        });
      }

      /* function createObject() {
        drivers.length = 0;

        for (var i = 1; i < 13; i++) {
          drivers.push({
            "position": parseInt(parseInt(document.getElementById('driver' + i + 'pos').value)),
            "name": document.getElementById('driver' + i + 'name').value,
            "points": parseInt(document.getElementById('driver' + i + 'pts').value),
            "nationality": getNationality(document.getElementById('driver' + i + 'name').value),
            "team": getTeam(document.getElementById('driver' + i + 'name').value)
          });
        }
      } */

      function generateImage() {
        console.log(drivers);
        document.getElementById('canvas').style.display = "block";
        createObject();

        var h1 = document.getElementById('headline').value;
        var h2 = document.getElementById('subline').value;
        var eventImg = '<img class="flag" src="img/flags/' + getCountry(h2) + '.png">';

        document.getElementById('h1').innerHTML = document.getElementById('headline').value;
        document.getElementById('h2').innerHTML = document.getElementById('subline').value;
        document.getElementById('country').innerHTML = eventImg;

        for (var i = 1; i < 13; i++) {
          document.getElementById('driver' + i).innerHTML =
          '<div class="position">' + drivers[(i-1)].position + '</div>' +
          '<div class="person">' +
            '<img class="flag" src="img/flags/' + drivers[(i-1)].nationality + '.png">' +
            '<div class="name">' + drivers[(i-1)].name + '</div>' +
            '<img class="car" src="img/cars/' + drivers[(i-1)].team + '.png">' +
          '</div>' +
          '<div class="points">' + drivers[(i-1)].points + '</div>';
        }

        document.getElementById('canvas').scrollIntoView();
      }
    </script>

  </body>
</html>
